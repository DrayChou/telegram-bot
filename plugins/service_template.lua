--[[
vardump msg: 
{
  date = 1433438016,
  flags = 16,
  from = {
    access_hash = 1,
    first_name = "Dray",
    flags = 528,
    id = 64163268,
    last_name = "ğŸŒ",
    phone = "16128881024",
    print_name = "Dray_ğŸŒ",
    type = "user"
  },
  id = "157104",
  out = false,
  service = false,
  text = "kick",
  to = {
    first_name = "Bot",
    flags = 144,
    id = 109098660,
    last_name = "DC",
    phone = "13134829895",
    print_name = "Bot_DC",
    type = "user"
  },
  unread = true
}
vardump chat_info: 
false


vardump msg: 
{
  date = 1433438082,
  flags = 16,
  from = {
    access_hash = 1,
    first_name = "Dray",
    flags = 528,
    id = 64163268,
    last_name = "ğŸŒ",
    phone = "16128881024",
    print_name = "Dray_ğŸŒ",
    type = "user"
  },
  id = "157108",
  out = false,
  service = false,
  text = "kick",
  to = {
    flags = 16,
    id = 17071158,
    members = {
      {
        access_hash = 1,
        first_name = "Star",
        flags = 24,
        id = 63406757,
        last_name = "Brilliant",
        print_name = "Star_Brilliant",
        real_first_name = "Star",
        real_last_name = "Brilliant",
        type = "user"
      },
      {
        access_hash = 1,
        first_name = "qiang",
        flags = 16,
        id = 91110543,
        print_name = "qiang",
        type = "user"
      },
      {
        access_hash = 1,
        first_name = "Akshay",
        flags = 16,
        id = 5750844,
        print_name = "Akshay",
        type = "user"
      },
      {
        access_hash = 1,
        first_name = "enin",
        flags = 16,
        id = 103502298,
        last_name = "An",
        print_name = "enin_An",
        type = "user"
      },
      {
        access_hash = 1,
        first_name = "arch",
        flags = 16,
        id = 109485440,
        last_name = "z",
        print_name = "arch_z",
        type = "user"
      },
      {
        access_hash = 1,
        first_name = "Jack",
        flags = 16,
        id = 54759533,
        last_name = "Soo",
        print_name = "Jack_Soo",
        type = "user"
      },
      {
        access_hash = 1,
        first_name = "Kyle",
        flags = 16,
        id = 53584340,
        last_name = "Ch",
        print_name = "Kyle_Ch",
        type = "user"
      },
      {
        access_hash = 1,
        first_name = "ï¼¢ï½ï½”ï½ï½ï½",
        flags = 16,
        id = 35794149,
        print_name = "ï¼¢ï½ï½”ï½ï½ï½",
        type = "user"
      },
      {
        access_hash = 1,
        first_name = "Sam",
        flags = 16,
        id = 101164042,
        last_name = "Sun",
        print_name = "Sam_Sun",
        type = "user"
      },
      {
        access_hash = 1,
        first_name = ".",
        flags = 16,
        id = 73213962,
        last_name = "Yip",
        print_name = "._Yip",
        type = "user"
      },
      {
        access_hash = 1,
        first_name = "Optimus",
        flags = 16,
        id = 74971568,
        last_name = "Prime",
        print_name = "Optimus_Prime",
        type = "user"
      },
      {
        access_hash = 1,
        first_name = "Telegram",
        flags = 16,
        id = 33333782,
        last_name = "Bot",
        print_name = "Telegram_Bot",
        type = "user"
      },
      {
        access_hash = 1,
        first_name = "Sweetiebot",
        flags = 16,
        id = 50441674,
        print_name = "Sweetiebot",
        type = "user"
      },
      {
        access_hash = 1,
        first_name = "MC",
        flags = 16,
        id = 39869021,
        last_name = "Faguette",
        print_name = "MC_Faguette",
        type = "user"
      },
      {
        access_hash = 1,
        first_name = "Dray",
        flags = 528,
        id = 64163268,
        last_name = "ğŸŒ",
        phone = "16128881024",
        print_name = "Dray_ğŸŒ",
        type = "user"
      },
      {
        access_hash = 1,
        first_name = "Umit",
        flags = 16,
        id = 79325645,
        last_name = "(Toby Cao)",
        print_name = "Umit_(Toby_Cao)",
        type = "user"
      },
      {
        access_hash = 1,
        first_name = "T.",
        flags = 16,
        id = 96704724,
        last_name = "C.",
        print_name = "T._C.",
        type = "user"
      },
      {
        access_hash = 1,
        first_name = "Keran",
        flags = 16,
        id = 104158516,
        last_name = "Cho",
        print_name = "Keran_Cho",
        type = "user"
      },
      {
        access_hash = 1,
        first_name = "Frank",
        flags = 16,
        id = 91025105,
        print_name = "Frank",
        type = "user"
      },
      {
        access_hash = 1,
        first_name = "Tony",
        flags = 16,
        id = 75508523,
        last_name = "Wu",
        print_name = "Tony_Wu",
        type = "user"
      },
      {
        access_hash = 1,
        first_name = "malong",
        flags = 16,
        id = 57018078,
        last_name = "lee",
        print_name = "malong_lee",
        type = "user"
      },
      {
        access_hash = 1,
        first_name = "å°çˆ±è±†",
        flags = 16,
        id = 87541146,
        print_name = "å°çˆ±è±†",
        type = "user"
      },
      {
        access_hash = 1,
        first_name = "Signal",
        flags = 16,
        id = 102853582,
        last_name = "Seeds",
        print_name = "Signal_Seeds",
        type = "user"
      },
      {
        access_hash = 1,
        first_name = "Noah",
        flags = 16,
        id = 100517449,
        last_name = "Sin",
        print_name = "Noah_Sin",
        type = "user"
      },
      {
        access_hash = 1,
        first_name = "å°",
        flags = 16,
        id = 110921271,
        last_name = "å±è‚¡",
        print_name = "å°_å±è‚¡",
        type = "user"
      },
      {
        access_hash = 1,
        first_name = "Dx.",
        flags = 16,
        id = 98963936,
        last_name = "Dennx",
        print_name = "Dx._Dennx",
        type = "user"
      },
      {
        access_hash = 1,
        first_name = "Yeechan",
        flags = 16,
        id = 69640050,
        last_name = "Lu",
        print_name = "Yeechan_Lu",
        type = "user"
      },
      {
        access_hash = 1,
        first_name = "pt950",
        flags = 16,
        id = 109783307,
        print_name = "pt950",
        type = "user"
      },
      {
        access_hash = 1,
        first_name = "milleelf",
        flags = 16,
        id = 53854830,
        print_name = "milleelf",
        type = "user"
      },
      {
        access_hash = 1,
        first_name = "Radium",
        flags = 16,
        id = 61330658,
        print_name = "Radium",
        type = "user"
      },
      {
        access_hash = 1,
        first_name = "Li",
        flags = 16,
        id = 31013380,
        print_name = "Li",
        type = "user"
      },
      {
        access_hash = 1,
        first_name = "Jelly",
        flags = 16,
        id = 100270920,
        print_name = "Jelly",
        type = "user"
      },
      {
        access_hash = 1,
        first_name = "Chanple",
        flags = 16,
        id = 102064612,
        print_name = "Chanple",
        type = "user"
      },
      {
        access_hash = 1,
        first_name = "Basith",
        flags = 16,
        id = 49858089,
        print_name = "Basith",
        type = "user"
      },
      {
        access_hash = 1,
        first_name = "é˜¿å¾·",
        flags = 16,
        id = 97061489,
        last_name = "é˜¿æ‹‰",
        print_name = "é˜¿å¾·_é˜¿æ‹‰",
        type = "user"
      },
      {
        access_hash = 1,
        first_name = "sandoo",
        flags = 16,
        id = 77677077,
        last_name = "liang",
        print_name = "sandoo_liang",
        type = "user"
      },
      {
        access_hash = 1,
        first_name = "Dr. MerkwÃ¼rdigliebe",
        flags = 16,
        id = 102430753,
        print_name = "Dr._MerkwÃ¼rdigliebe",
        type = "user"
      },
      {
        access_hash = 1,
        first_name = "Bot",
        flags = 16,
        id = 103260651,
        print_name = "Bot",
        type = "user"
      },
      {
        access_hash = 1,
        first_name = "å°",
        flags = 16,
        id = 90580115,
        last_name = "æºªæµ",
        print_name = "å°_æºªæµ",
        type = "user"
      },
      {
        access_hash = 1,
        first_name = "Jaconda",
        flags = 16,
        id = 72006705,
        print_name = "Jaconda",
        type = "user"
      },
      {
        access_hash = 1,
        first_name = "Jesse",
        flags = 16,
        id = 77076588,
        print_name = "Jesse",
        type = "user"
      },
      {
        first_name = "Bot",
        flags = 144,
        id = 109098660,
        last_name = "DC",
        phone = "13134829895",
        print_name = "Bot_DC",
        type = "user"
      },
      {
        access_hash = 1,
        first_name = "Fwolf",
        flags = 16,
        id = 99940312,
        print_name = "Fwolf",
        type = "user"
      },
      {
        access_hash = 1,
        first_name = "Kane",
        flags = 16,
        id = 69267645,
        print_name = "Kane",
        type = "user"
      },
      {
        access_hash = 1,
        first_name = "Liberbot",
        flags = 16,
        id = 100547061,
        print_name = "Liberbot",
        type = "user"
      },
      {
        access_hash = 1,
        first_name = "otouto",
        flags = 16,
        id = 66603334,
        print_name = "otouto",
        type = "user"
      },
      {
        access_hash = 1,
        first_name = "Kunana",
        flags = 16,
        id = 108512323,
        last_name = "XP",
        print_name = "Kunana_XP",
        type = "user"
      },
      [0] = {
        access_hash = 1,
        first_name = "dabao",
        flags = 16,
        id = 96586640,
        last_name = "ou",
        print_name = "dabao_ou",
        type = "user"
      }
    },
    members_num = 48,
    print_name = "Bots-æµ‹è¯•è¯·å’Œæœºå™¨äººç§èŠï¼Œå‹¿åœ¨å…¬å…±é¢‘é“åˆ·",
    title = "Bots-æµ‹è¯•è¯·å’Œæœºå™¨äººç§èŠï¼Œå‹¿åœ¨å…¬å…±é¢‘é“åˆ·",
    type = "chat"
  },
  unread = true
}
vardump chat_info: 
false
]]

local function user_print_name(user)
    local text = ''
    if user.print_name then
        text = user.print_name
    else
        if user.first_name then
            text = user.last_name..' '
        end
        if user.lastname then
            text = text..user.last_name
        end
    end
    
    if user.username then
        text = text..' @'..user.username
    end
    
    return text
end

-- Returns a table with `name` and `msgs` and `msgs_day`
local function get_msgs_user_chat(user_id, chat_id, day_id)
    local user_info = {}
    local uhash = 'user:'..user_id
    local user = redis:hgetall(uhash)
    
    local um_hash = 'msgs:'..user_id..':'..chat_id..':'..day_id
    if day_id == 'ALL' then
        um_hash = 'msgs:'..user_id..':'..chat_id
    end
    
    if day_id == 'TODAY' or day_id == 'TD' then
        um_hash = 'msgs:'..user_id..':'..chat_id..':'..os.date("%Y%m%d")
    end
    
    user_info.name = user_print_name(user)..' ('..user_id..')'
    user_info.msgs = tonumber(redis:get(um_hash) or 0)
    return user_info
end

local function run(msg, matches)
    local chat_id = '17071158'
    local day_id = 'ALL'
    
    -- ä»ç”¨æˆ·æ¶ˆæ¯çš„å—ä¼—é‚£è¾¹æ‹¿åˆ°ç”¨æˆ·åˆ—è¡¨
    local users = {}
    for i = 1, #msg.to.members do
        local user = msg.to.members[i]
        if user.type == 'user' then
            local user_id = user.id
            local user_info = get_msgs_user_chat(user_id, chat_id, day_id)
            table.insert(users, user_info)
        end
    end
    
    vardump(users)
    
    -- avoid this plugins to process user messages
    if not msg.realservice then
        -- return "Are you trying to troll me?"
        return nil
    end
    print("Service message received: " .. matches[1])
end

return {
    description = "Template for service plugins",
    usage = "",
    patterns = {
        "^!!tgservice (.*)$", -- Do not use the (.*) match in your service plugin
    },
    run = run
}
